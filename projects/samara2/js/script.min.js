(function() {
  // let days = document.querySelector('#days');
  // let daysLabel = document.querySelector('#label-days');
  let hoursLabel = document.querySelector('#label-hours');
  let minutesLabel = document.querySelector('#label-minutes');
  let hours = document.querySelector('#hours');
  let minutes = document.querySelector('#minutes');
  let seconds = document.querySelector('#seconds');

  // let dd = document.querySelector('#dd');
  let hh = document.querySelector('#hh');
  let mm = document.querySelector('#mm');
  let ss = document.querySelector('#ss');


  let declOfNum = function(number, titles) {
    let cases = [2, 0, 1, 1, 1, 2];
    return titles[
      number % 100 > 4 && number % 100 < 20
        ? 2
        : cases[number % 10 < 5 ? number % 10 : 5]
    ];
  };

  //declOfNum(days, ['день', 'дня', 'дней']);
  //declOfNum(hours, ['час', 'часа', 'часов']);
  //declOfNum(minutes, ['минута', 'минуты', 'минут']);
  //declOfNum(seconds, ['секунда', 'секунды', 'секунд']);

  let deadline = new Date('May 24, 2025 00:00:00').getTime();
  // console.log(deadline);

  let x = setInterval(function() {
    let now = new Date().getTime();
    let t = deadline - now;

    // let d = Math.floor(t / (1000 * 60 * 60 * 24));
    let h = Math.floor(t % (1000 * 60 * 60 * 24) / (1000 * 60 * 60));
    let m = Math.floor(t % (1000 * 60 * 60) / (1000 * 60));
    let s = Math.floor(t % (1000 * 60) / 1000);

    // days.textContent = d;
    hours.textContent = h;
    minutes.textContent = m;
    seconds.textContent = s;

    // daysLabel.textContent = declOfNum(d, ['день', 'дня', 'дней']);
    hoursLabel.textContent = declOfNum(h, ['час', 'часа', 'часов']);
    minutesLabel.textContent = declOfNum(m, ['минута', 'минуты', 'минут']);

    // dd.style.strokeDashoffset = 440 - 440 * d / 365;
    hh.style.strokeDashoffset = 440 - 440 * h / 24;
    mm.style.strokeDashoffset = 440 - 440 * m / 60;
    ss.style.strokeDashoffset = 440 - 440 * s / 60;

    if (t < 0) {
      clearInterval(x);
      // d = 0;
      h = 0;
      m = 0;
      s = 0;

      // days.textContent = d;
      hours.textContent = h;
      minutes.textContent = m;
      seconds.textContent = s;

      // dd.style.strokeDashoffset = 440 - 440 * d / 365;
      hh.style.strokeDashoffset = 440 - 440 * h / 24;
      mm.style.strokeDashoffset = 440 - 440 * m / 60;
      ss.style.strokeDashoffset = 440 - 440 * s / 60;

      // document.querySelector('.timer').style.display = 'none';
    }
  }, 100);
})();

const acc = document.getElementsByClassName("accordion");
let i;

for (i = 0; i < acc.length; i++) {
  acc[i].addEventListener("click", function() {
    this.classList.toggle("active");
    const panel = this.nextElementSibling;
    if (panel.style.display === "block") {
      panel.style.display = "none";
    } else {
      panel.style.display = "block";
    }
  });
}


function onEntry(entry) {
  entry.forEach(change => {
    if (change.isIntersecting) {
     change.target.classList.add('element-show');
    }
  });
}

let options = {
  threshold: [0.5] };
let observer = new IntersectionObserver(onEntry, options);
let elements = document.querySelectorAll('.element-animation');

for (let elm of elements) {
  observer.observe(elm);
}

const page = document.querySelector('.page');
const body = document.querySelector('.page-body');
const navigation = document.querySelector('.navigation');
const btnClose = navigation.querySelector('.btn-close');
const btnOpen = document.querySelector('.page-header__btn-menu');

navigation.addEventListener('click', e => {
  e.preventDefault();
  const elem = e.target;
  if (elem.tagName === 'A') {
    const activeId = elem.href.split('#')[1];

    document.getElementById(activeId).scrollIntoView({
      behavior: 'smooth',
      block: 'start',
    });

    onCloseMenu();
  }
});

const onOverlayCreate = () => {
  const div = document.createElement('div');
  div.className = 'overlay';
  body.appendChild(div);
};

const onOpenMenu = () => {
  if (navigation.classList.contains('close')) {
    navigation.classList.remove('close');
  }

  navigation.classList.add('open');

  onOverlayCreate();
  page.classList.add('no-scroll');

  if (document.querySelector('.overlay')) {
    document.querySelector('.overlay').addEventListener('click', onCloseMenu);
  }
};
const onCloseMenu = () => {
  navigation.classList.remove('open');
  navigation.classList.add('close');
  document.querySelector('.overlay').remove();
  page.classList.remove('no-scroll');
};

btnClose.addEventListener('click', onCloseMenu);
btnOpen.addEventListener('click', onOpenMenu);

const handleClickEscape = e => {
  if (e.key === 'Escape') {
    onCloseMenu();
  }
};

window.addEventListener('keydown', handleClickEscape);

// Всплывающее окно при закрытии страницы
$(document).mouseleave(function(e){
  if (e.clientY < 0) {
  $("#modal-stop").modal('show');
  }
 });
 // Если окно закрыли, то удаляем его, чтобы оно больше не открывалось
 $('#modal-stop').on('hidden.bs.modal', function () {
  $("#modal-stop").remove();
 });

const BASE_URL = 'https://pro.fitnesshouse.ru/payments/';
// проверка ответа
const checkResponse = res => {
  if (res.ok) {
    return res.json();
  }
  return Promise.reject(`Ошибка ${res.status}`);
};

const checkSuccess = res => {
  if (res && res.success) {
    return res;
  }
  return Promise.reject(`Ответ не success: ${res}`);
};

export const generalRequest = (endpoint, options) => {
  return fetch(`${BASE_URL}${endpoint}/`, options).then(checkResponse);
  // .then(checkSuccess);
};

// валидация формы
let forms = document.querySelectorAll('.needs-validation');

// Tooltip
new bootstrap.Tooltip(document.getElementById('tooltip14'), {
  title: 'Услуга не может быть оказана лицам моложе 14 лет',
  placement: 'right',
});
new bootstrap.Tooltip(document.getElementById('tooltip1'), {
  title: 'Услуга не может быть оказана лицам моложе 14 лет',
  placement: 'right',
});

// mask
$('.mask-phone').inputmask('+7 (999) 999-99-99', {
  placeholder: '+7 (***) ***-**-**',
  removeMaskOnSubmit: true,
});

// Только буквы английского и русского алфавита
$('body').on('input', '.input-words', function(){
	this.value = this.value.replace(/[^a-zа-яё\s]/gi, '');
});

// количество одинаковых цифр в строке
const orderedCount = text => {
  return Array.from(
    text.split('').reduce((acc, el) => {
      acc.set(el, (acc.get(el) || 0) + 1);
      return acc;
    }, new Map()),
  );
};

const checkPhone = phone => {
  let tel = phone.value.replace(/[^+\d]/g, '');
  let num = phone.value.replace(/[^+\d]/g, '').length;
  return num === 10 && orderedCount(tel)[0][1] < 10;
};

const nowAgeUser = val => {
  var now = new Date(); //Текущя дата
  var today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); //Текущя дата без времени
  // var dob = new Date(1988, 6, 26); //Дата рождения
  var dob = new Date(val);
  var dobnow = new Date(today.getFullYear(), dob.getMonth(), dob.getDate()); //ДР в текущем году
  var age; //Возраст

  //Возраст = текущий год - год рождения
  age = today.getFullYear() - dob.getFullYear();
  //Если ДР в этом году ещё предстоит, то вычитаем из age один год
  if (today < dobnow) {
    age = age - 1;
  }

  return age;
};

const maxValueDate = () => {
  const nowDate = new Date().toLocaleDateString(); //Текущя дата
  const m = nowDate.slice(3, 5);
  const d = nowDate.slice(0, 2);

  const y = new Date().getFullYear() - 14; // 14 лет сегодня
  const result = y + '-' + m + '-' + d;

  return result;
};

const onCheckValidateForm = form => {
  let isValidate = false;
  const phoneForm = form.querySelector('[type="tel"]');
  const dataForm = form.querySelector('[type="date"]');
  const checkPhoneForm = checkPhone(phoneForm);
  const checkDateForm = nowAgeUser(dataForm.value) >= 14;

  if (!checkPhoneForm || !checkDateForm) {
    form.classList.add('was-validated');
    if (!checkPhoneForm) {
      phoneForm.classList.add('is-invalid');
    }
  } else {
    form.classList.remove('was-validated');
    phoneForm.classList.remove('is-invalid');
    return (isValidate = !isValidate);
  }

  return isValidate;
};

const onSubmitForm = e => {
  let formData = new FormData(e.target);
  let data = {
    customer: {
      first_name: formData.get('first_name'),
      last_name: formData.get('last_name'),
      phone: formData.get('phone'),
      birth_day: formData.get('birth_day'),
      email: formData.get('email'),
    },
    product: {
      name: formData.get('name'),
      price: formData.get('price'),
      price_id: formData.get('price_id'),
    },
  };
  let raw = JSON.stringify(data);

  let myHeaders = new Headers();
  myHeaders.append('Content-Type', 'application/json');

  let requestOptions = {
    method: 'POST',
    headers: myHeaders,
    body: raw,
    redirect: 'follow',
  };

  generalRequest('orders', requestOptions)
    .then(result => {
      if (result.pay_url) {
        console.log(result.pay_url);
        window.location = result.pay_url;
      }
    })
    .catch(error => console.log('error', error));
};

document.addEventListener('DOMContentLoaded', () => {
  forms.forEach(form => {
    form
      .querySelector('[type="date"]')
      .setAttribute('max', maxValueDate());

    form.addEventListener('submit', function(e) {
      e.preventDefault();

      if (onCheckValidateForm(form)) {
        // добавляю disabled для кнопки
        let btn = form.querySelector('[type="submit"]');
        btn.setAttribute('disabled', true);

        // отправка формы
        onSubmitForm(e);

        // очистка полей формы
        form.reset();
      }
    });
  });
});

const messengers = document.querySelector('.messengers');
const btn = document.querySelector('.messengers .btn-close');

if (messengers) {
  btn.addEventListener('click', () => {
    messengers.classList.add('messengers--close');
  })
}

const pageBody = document.querySelector('.page-body');

const scrollUp = 'scroll-up';
const scrollDown = 'scroll-down';
let lastScroll = 0;

window.addEventListener('scroll', () => {
  const currentScroll = window.pageYOffset;
  if (currentScroll <= 0) {
    pageBody.classList.remove(scrollUp);
    return;
  }

  if (currentScroll > lastScroll && !pageBody.classList.contains(scrollDown)) {
    // down
    pageBody.classList.remove(scrollUp);
    pageBody.classList.add(scrollDown);
  } else if (
    currentScroll < lastScroll &&
    pageBody.classList.contains(scrollDown)
  ) {
    // up
    pageBody.classList.remove(scrollDown);
    pageBody.classList.add(scrollUp);
  }
  lastScroll = currentScroll;
});

